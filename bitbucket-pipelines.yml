image: node:16

pipelines:
  pull-requests:
    "**":
      - step:
          name: Initial setup
          condition:
            changesets:
              includePaths:
                # any changes in given directory
                - "packages/react-icons/src/**"
                - "packages/react-components/src/**"
                - "packages/docs/**"
          script:
            - npm install -g yarn lerna
            - yarn
          artifacts:
            - node_modules/**
          caches:
            - node
      - step:
          name: Security Scan for React Icons
          script:
            - cd packages/react-icons
            # Run a security scan for sensitive data.
            # See more security tools at https://bitbucket.org/product/features/pipelines/integrations?&category=security
            - pipe: atlassian/git-secrets-scan:0.5.1

      - step:
          name: Run eslint
          condition:
            changesets:
              includePaths:
                # any changes in given directory
                - "packages/react-icons/src/**"
          script:
            - cd packages/react-icons
            - npx eslint .

      - step:
          name: Build Icons
          condition:
            changesets:
              includePaths:
                # any changes in given directory
                - "packages/react-icons/src/**"
                - "packages/react-components/src/**"
                - "packages/docs/**"
          artifacts:
            - packages/react-icons/dist/**
          script:
            - npx nx reset
            - lerna run build --scope=@sparrowengg/twigs-react-icons

      # components
      - step:
          name: Security Scan for React Components
          script:
            - cd packages/react-components
            - pipe: atlassian/git-secrets-scan:0.5.1
      - step:
          name: Run eslint
          condition:
            changesets:
              includePaths:
                # any changes in given directory
                - "packages/react-components/src/**"
          script:
            - cd packages/react-components
            - npx eslint .
      - step:
          name: Test
          condition:
            changesets:
              includePaths:
                - "packages/react-components/src/**"
          script:
            - lerna run test
      - step:
          name: Build Components
          condition:
            changesets:
              includePaths:
                - "packages/react-components/src/**"
                - "packages/docs/**"
          script:
            - npx nx reset
            - lerna run build --scope=@sparrowengg/twigs-react

      - step:
          name: Security Scan for Docs
          script:
            - cd packages/docs
            - pipe: atlassian/git-secrets-scan:0.5.1
      - step:
          name: Build docs
          condition:
            changesets:
              includePaths:
                - "packages/docs/**"
          script:
            - npx nx reset
            - lerna run build --scope=@sparrowengg/twigs-docs --verbose

  branches:
    master:
      - parallel:
          - step:
              name: Security Scan for React Icons
              script:
                - cd packages/react-icons
                # Run a security scan for sensitive data.
                # See more security tools at https://bitbucket.org/product/features/pipelines/integrations?&category=security
                - pipe: atlassian/git-secrets-scan:0.5.1

          - step:
              name: Run eslint
              script:
                - cd packages/react-icons
                - npm install eslint
                - npx eslint .
              caches:
                - node

          - step:
              name: Build Icons
              caches:
                - node
              script:
                - npm install -g lerna
                - yarn install
                - lerna run build --scope=@sparrowengg/twigs-react-icons

      # components
      - parallel:
          - step:
              name: Security Scan for React Components
              script:
                - cd packages/react-components
                - pipe: atlassian/git-secrets-scan:0.5.1
          - step:
              name: Run eslint
              script:
                - cd packages/react-components
                - npm install eslint
                - npx eslint .
              caches:
                - node

          - step:
              name: Build Components
              caches:
                - node
              script:
                - npm install -g lerna
                - yarn install
                - lerna run build --scope=@sparrowengg/twigs-react

          - step:
              name: Create changelog
              script:
                - cd packages/react-components
                - npx auto-changelog changelog
                - npm run changelog:commit
      # docs
      - parallel:
          - step:
              name: Security Scan for Docs
              script:
                - cd packages/docs
                - pipe: atlassian/git-secrets-scan:0.5.1
          - step:
              name: Build docs
              condition:
                changesets:
                  includePaths:
                    - "packages/docs/**"
              caches:
                - node
              script:
                - npm install -g lerna
                - yarn install
                - lerna run build --scope=@sparrowengg/twigs-docs --verbose
